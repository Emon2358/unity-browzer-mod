<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>FBX → VRM1.x Converter (Browser + glTF-Transform)</title>

  <!-- importmap で依存関係を解決 -->
  <script type="importmap">
  {
    "imports": {
      "three": "https://cdn.jsdelivr.net/npm/three@0.176.0/build/three.module.js",
      "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.176.0/examples/jsm/",
      // glTF-Transform のブラウザビルド
      "@gltf-transform/core": "https://cdn.jsdelivr.net/npm/@gltf-transform/core@3.21.0/dist/gltf-transform-core.browser.esm.js",
      "@gltf-transform/extensions": "https://cdn.jsdelivr.net/npm/@gltf-transform/extensions@3.21.0/dist/extensions.browser.esm.js"
    }
  }
  </script>

  <script type="module">
    import * as THREE        from 'three';
    import { FBXLoader }     from 'three/addons/loaders/FBXLoader.js';
    import { GLTFExporter }  from 'three/addons/exporters/GLTFExporter.js';
    import { WebIO }         from '@gltf-transform/core';
    import { VRMC_vrm }      from '@gltf-transform/extensions';

    const fbxInput    = document.getElementById('fbx-input');
    const titleInput  = document.getElementById('meta-title');
    const authorInput = document.getElementById('meta-author');
    const convertBtn  = document.getElementById('convert-btn');

    let fbxScene = null;
    fbxInput.addEventListener('change', async (evt) => {
      const file = evt.target.files[0];
      const array = await file.arrayBuffer();
      fbxScene = new FBXLoader().parse(array, '');
      alert(`FBX loaded: ${file.name}`);
    });

    convertBtn.addEventListener('click', () => {
      if (!fbxScene) {
        alert('まず FBX をアップロードしてください');
        return;
      }

      // 1) GLB に変換
      const exporter = new GLTFExporter();
      exporter.parse(
        fbxScene,
        async (result) => {
          // result は { binary: ArrayBuffer, ... }
          const glbBytes = new Uint8Array(result.binary);

          // 2) glTF-Transform で VRM1.x + metadata を埋め込む
          const io = new WebIO()
            .registerExtensions([ VRMC_vrm ])
            .registerDependencies({
              // VRMC_vrm は依存なし
            });

          // ドキュメントを読み込み
          const doc = await io.readBinary(glbBytes);

          // VRMC_vrm 拡張を作成してメタを埋め込む
          const vrmExt = doc.createExtension(VRMC_vrm);
          const meta   = vrmExt.createMetadata();
          meta.setTitle( titleInput.value  || 'MyAvatar' );
          meta.setAuthor( authorInput.value || 'Anonymous' );

          // 3) バイナリ VRM を書き出し
          const vrmBytes = await io.writeBinary(doc);
          
          // ダウンロード
          const blob = new Blob([vrmBytes], { type: 'application/octet-stream' });
          const url  = URL.createObjectURL(blob);
          const a    = document.createElement('a');
          a.href     = url;
          a.download = `${titleInput.value || 'avatar'}.vrm`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        },
        { binary: true }
      );
    });
  </script>
</head>
<body>
  <h1>FBX → VRM1.x Converter</h1>
  <p>1. FBX ファイルを選択</p>
  <input type="file" id="fbx-input" accept=".fbx" />

  <p>2. メタデータを入力</p>
  <label>タイトル: <input type="text" id="meta-title" value="MyAvatar" /></label>
  <label>作者:   <input type="text" id="meta-author" value="Browser Converter" /></label>

  <p>3. 変換スタート</p>
  <button id="convert-btn">VRM に変換＆ダウンロード</button>
</body>
</html>
