<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>FBX → VRM1.x Converter (Browser)</title>

  <!-- importmap でモジュールの解決先を指定 -->
  <script type="importmap">
  {
    "imports": {
      "three": "https://cdn.jsdelivr.net/npm/three@0.176.0/build/three.module.js",
      "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.176.0/examples/jsm/",
      "@pixiv/three-vrm": "https://cdn.jsdelivr.net/npm/@pixiv/three-vrm@3.4.1/lib/three-vrm.module.min.js"
    }
  }
  </script>

  <script type="module">
    import * as THREE           from 'three';
    import { FBXLoader }        from 'three/addons/loaders/FBXLoader.js';
    import { GLTFExporter }     from 'three/addons/exporters/GLTFExporter.js';
    import { VRMExporter }      from '@pixiv/three-vrm';

    window.addEventListener('DOMContentLoaded', () => {
      const fbxInput    = document.getElementById('fbx-input');
      const titleInput  = document.getElementById('meta-title');
      const authorInput = document.getElementById('meta-author');
      const convertBtn  = document.getElementById('convert-btn');

      let loadedScene = null;

      // 1) FBX を読み込む
      fbxInput.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const array = await file.arrayBuffer();
        const loader = new FBXLoader();
        loadedScene = loader.parse(array, '');
        alert(`FBX loaded: ${file.name}`);
      });

      // 2) 変換＆ダウンロード
      convertBtn.addEventListener('click', async () => {
        if (!loadedScene) {
          alert('まず FBX をアップロードしてください');
          return;
        }

        // glTF（GLB）に変換
        const gltfExporter = new GLTFExporter();
        gltfExporter.parse(
          loadedScene,
          async (gltf) => {
            // VRM1.x に変換（メタデータ埋め込み）
            const vrmArray = await VRMExporter.parse(gltf, {
              title:  titleInput.value  || 'MyAvatar',
              author: authorInput.value || 'Anonymous',
            });

            // ダウンロード
            const blob = new Blob([vrmArray], { type: 'application/octet-stream' });
            const url  = URL.createObjectURL(blob);
            const a    = document.createElement('a');
            a.href     = url;
            a.download = `${titleInput.value || 'avatar'}.vrm`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
          },
          { binary: true }
        );
      });
    });
  </script>
</head>
<body>
  <h1>FBX → VRM1.x Converter</h1>
  <p>1. FBX ファイルを選択</p>
  <input type="file" id="fbx-input" accept=".fbx" />

  <p>2. メタデータを入力</p>
  <label>
    タイトル:
    <input type="text" id="meta-title" value="MyAvatar" />
  </label>
  <label>
    作者:
    <input type="text" id="meta-author" value="Browser Converter" />
  </label>

  <p>3. 変換スタート</p>
  <button id="convert-btn">VRM に変換＆ダウンロード</button>
</body>
</html>
