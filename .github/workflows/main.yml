# .github/workflows/extract-unitypackage.yml
name: Download UnityPackage, Extract and Commit VRM

on:
  workflow_dispatch:

permissions:
  contents: write  # リポジトリへの書き込みを許可

jobs:
  download-extract-commit:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        persist-credentials: true

    - name: Download UnityPackage
      id: download_pkg
      run: |
        URL="https://workupload.com/file/GYC875CeJw4"
        echo "Downloading from $URL"
        curl -L "$URL" -o downloaded.unitypackage
        if [[ ! -s downloaded.unitypackage ]]; then
          echo "Download failed or file empty"
          exit 1
        fi
        echo "unity_pkg=downloaded.unitypackage" >> $GITHUB_OUTPUT

    - name: Ensure output directories
      run: |
        mkdir -p extracted
        mkdir -p vrm-output

    - name: Install extraction tools
      run: |
        sudo apt-get update -y
        sudo apt-get install -y p7zip-full

    - name: Extract UnityPackage
      run: |
        # .unitypackage は専用形式の圧縮アーカイブのため 7z で展開
        7z x downloaded.unitypackage -oextracted > extraction.log
        if [ $? -ne 0 ]; then
          echo "Extraction failed. Check extraction.log for details."
          exit 1
        fi

    - name: List extracted files
      run: |
        echo "## Files in UnityPackage:" 
        find extracted -type f | tee extracted/files.txt

    - name: Find and Copy VRM files
      id: copy_vrms
      run: |
        VRM_LIST=$(find extracted -type f -name '*.vrm')
        if [[ -z "$VRM_LIST" ]]; then
          echo "No VRM files found."
          exit 0
        fi
        for F in $VRM_LIST; do
          echo "Copying $F"
          cp "$F" vrm-output/
        done

    - name: Commit extracted VRM
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add vrm-output/
        if git diff --cached --quiet; then
          echo "No VRM changes to commit"
        else
          git commit -m "Add/update extracted VRM files from downloaded.unitypackage"
          git push
        fi
